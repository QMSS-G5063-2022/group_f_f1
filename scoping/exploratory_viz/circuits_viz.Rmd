---
title: "f1_exploratory"
author: "Christa Chiao"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

rm(list = ls())
```

```{r}
# broken thing to call files but just run the `load_files_code.R` script that is 
# in the scoping folder. 

# library(dplyr)
# library(stringr)

# if the files are in a different location than your working directory, change
# the file path in the list.files function
# file_names <- list.files()

# read all 13 csvs into a list called "all_csvs"
# all_csvs <- lapply(file_names, read.csv)

# Set the name of each list element to its respective file name.
# names(all_csvs) <- gsub(".csv","",
#                        list.files(full.names = FALSE),
#                        fixed = TRUE)

# break list out into separate dfs
# list2env(all_csvs, envir=.GlobalEnv)

```

## Sankey Diagram

```{r}
library(dplyr)
# install.packages("networkD3")
# Let's get data into the format we need. We need two dfs, one of nodes that has
# all of the options, which is 0-20, which is the positions you can start in and 
# the positions you can end in. and of links, which gives you the start and end
# positions, the count of times a driver has ended up in those positions, and
# the driver name

# shoudl also do this for constructor, maybe let's do that one first.

nodes <- c("0","1","2","3","4","5","6","7","8","9","10",
"11","12","13","14","15","16","17","18","19","20",
"21","22","23","24","25","26","27","28","29","30",
"31","32","33","34","35","36","37","38","39","40"
          )

nodes <- as.data.frame(nodes)

library(tidyr)
links_driver <- 
  results %>%
  left_join(races, by = "raceId") %>%
  filter(year == 2019 | year == 2021) %>%
  left_join(drivers, by = "driverId") %>%
  unite("full_name", forename:surname, sep= " ", remove = FALSE) %>%
  select(raceId, driverId, full_name, positionOrder) %>%
  rename(race_position = positionOrder) %>%
  left_join(qualifying, by = c("raceId" = "raceId", 
                               "driverId" = "driverId"
                               )) %>%
  select(raceId, full_name, race_position, position) %>%
  rename(quali_position = position) %>%
  mutate(quali_position = as.integer(quali_position)) %>%
  mutate(race_position = if_else(race_position == "\\N", 0, as.numeric(race_position)),
         quali_position = if_else(is.na(quali_position), 0, as.numeric(quali_position))) %>%
  group_by(full_name, race_position, quali_position) %>%
  summarise(n = n()) %>%
  rename(target = race_position,
         source = quali_position,
         value = n) %>%
  mutate(source = source,
         target =  target + 20) %>%
    mutate(target = as.integer(target),
         source = as.integer(source))

links_driver_lh <- links_driver %>% filter(full_name == "Lewis Hamilton")
links_driver_lh <- as.data.frame(links_driver_lh)


links_driver_mv <- links_driver %>% filter(full_name == "Max Verstappen")
links_driver_mv <- as.data.frame(links_driver_mv)


links_driver_lhmv <- links_driver %>% filter(full_name == "Lewis Hamilton" | 
                                               full_name == "Max Verstappen")
links_driver_lhmv <- as.data.frame(links_driver_lhmv)


library(networkD3)

# Colour links
my_color_0 <- 
  'd3.scaleOrdinal() .domain(["Lewis Hamilton"]) .range(["#6CD3BF"])'

my_color_1 <- 
  'd3.scaleOrdinal() .domain(["Max Verstappen"]) .range(["#1E41FF"])'

my_color <- 
  'd3.scaleOrdinal() .domain(["Lewis Hamilton", "Max Verstappen"]) .range(["#6CD3BF", "#1E41FF"])'

sankeyNetwork(Links = links_driver_mv, Nodes = nodes, Source = "source",
              Target = "target", Value = "value", 
              NodeID = "nodes", colourScale=my_color_1, LinkGroup = "full_name",
              NodeGroup = NULL)

sankeyNetwork(Links = links_driver_lh, Nodes = nodes, Source = "source",
              Target = "target", Value = "value", 
              NodeID = "nodes", colourScale=my_color_0, LinkGroup = "full_name",
              NodeGroup = NULL)

sankeyNetwork(Links = links_driver_lhmv, Nodes = nodes, Source = "source",
              Target = "target", Value = "value", 
              NodeID = "nodes", fontSize= 15, nodeWidth = 20, margin = list(left = 100),
              colourScale=my_color, LinkGroup = "full_name",
              NodeGroup = NULL)

# save the widget
# library(htmlwidgets)
# saveWidget(p, file=paste0( getwd(), "/HtmlWidget/sankeyColor3.html"))

```
```{r}

sankeyNetwork(Links = links_driver_lh, Nodes = nodes, Source = "source",
              Target = "target", Value = "value", 
              NodeID = "nodes", colourScale=my_color_0, LinkGroup = "full_name",
              NodeGroup = NULL)

```

Constructor's Sankey Diagram
```{r}

links_const <- 
  results %>%
  left_join(races, by = "raceId") %>%
  filter(year == 2019 | year == 2021) %>%
  left_join(constructors, by = "constructorId") %>%
  rename(const_name = name.y) %>%
  select(raceId, constructorId, const_name, position) %>%
  rename(race_position = position) %>%
  left_join(qualifying, by = c("raceId" = "raceId", 
                               "constructorId" = "constructorId"
                               )) %>%
  select(raceId, const_name, race_position, position) %>%
  rename(quali_position = position) %>%
  mutate(quali_position = as.integer(quali_position)) %>%
  mutate(race_position = if_else(race_position == "\\N", 0, as.numeric(race_position)),
         quali_position = if_else(is.na(quali_position), 0, as.numeric(quali_position))) %>%
  group_by(const_name, race_position, quali_position) %>%
  summarise(n = n()) %>%
  rename(target = race_position,
         source = quali_position,
         value = n) %>%
  mutate(source = source,
         target =  target + 20) %>%
    mutate(target = as.integer(target),
         source = as.integer(source))


links_const_merc <- links_const %>% filter(const_name == "Mercedes")
links_const_merc <- as.data.frame(links_const_merc)


links_const_rb <- links_const %>% filter(const_name == "Red Bull")
links_const_rb <- as.data.frame(links_const_rb)

library(networkD3)

# Colour links
my_color_0 <- 
  'd3.scaleOrdinal() .domain(["Mercedes"]) .range(["#6CD3BF"])'

my_color_1 <- 
  'd3.scaleOrdinal() .domain(["Red Bull"]) .range(["#1E5BC6"])'

my_color <- 
  'd3.scaleOrdinal() .domain(["Alfa Romeo", "Alpha Tauri", "Alpine F1 Team", "Aston Martin", "Ferrari", "Haas F1 Team", "McLaren", "Mercedes", "Racing Point", "Red Bull", "Renault", "Toro Rosso", "Williams"]) .range(["#B12039", "#4E7C9B", "#2293D1", "#2D826D", "#ED1C24", "#B6BABD", "#F58020", "#6CD3BF", "#F596C8", "#1E41FF", "#FFF500", "#469BFF", "#FFFFFF"])'
```

Mercedes' Constructors Sankey Diagram
```{r}
sankeyNetwork(Links = links_const_merc, Nodes = nodes, Source = "source",
              Target = "target", Value = "value", 
              NodeID = "nodes", colourScale=my_color_0, LinkGroup = "const_name",
              NodeGroup = NULL)
```

Red Bull Constructor Sankey Diagram
```{r}
sankeyNetwork(Links = links_const_rb, Nodes = nodes, Source = "source",
              Target = "target", Value = "value", 
              NodeID = "nodes", colourScale=my_color_1, LinkGroup = "const_name",
              NodeGroup = NULL)
```

All Constructor Sankey Diagram
```{r}
sankeyNetwork(Links = links_const, Nodes = nodes, Source = "source",
              Target = "target", Value = "value", 
              NodeID = "nodes", fontSize= 15, nodeWidth = 20, margin = list(left = 100),
              colourScale=my_color, LinkGroup = "const_name",
              NodeGroup = NULL)
```



### Helper Tables
```{r}
library(dplyr)

circuits_joined <- circuits %>%
                  left_join(circuit_type) %>%
                  rename(circuit_name = name)

circuits_by_year <- races %>%
  select(raceId, year, circuitId, name) %>%
  rename(race_name = name) %>%
  left_join(circuits_joined, by = c("circuitId")) %>%
  mutate(circuit_type = 
           case_when(street_circuit == 1 ~ "street",
                     road_circuit == 1 ~ "street",
                     race_circuit == 1 ~ "race",
                     )
         ) %>%
  select(year, circuitId, circuit_name, circuit_type)

skinny_races_circuits <- races %>%
  rename(race_name = name) %>%
  select(raceId, circuitId, race_name, year)

xover <- 
  results %>%
  left_join(races, by = ("raceId")) %>%
  filter(year == 2019 | year == 2021) %>%
  select(driverId, constructorId, year) %>%
  left_join(drivers, by = ("driverId")) %>%
  left_join(constructors, by = ("constructorId")) %>%
  mutate(full_name = paste(forename, surname)) %>%
  rename(constructor_name = name) %>%
  select(driverId, full_name, constructorId, constructor_name, year) %>%
  group_by(driverId, full_name, constructorId, constructor_name, year) %>% 
  slice(1)
```


This plot_ly graph shows how many times drivers have gotten the "Fastest Lap" designation. The "Fastest Lap" designation gives the driver and the constructor extra points and monetary bonuses. 
```{r}
lap_times_by_driver_2019 <- 
  lap_times %>%
  left_join(skinny_races_circuits, by = ("raceId")) %>%
  filter(year == 2019) %>%
  left_join(xover, by = c("driverId" = "driverId",
                          "year" = "year")) %>%
  group_by(year, raceId, driverId, full_name, constructor_name) %>%
  summarise(min(milliseconds)) %>%
  rename(fastestLap_ms = "min(milliseconds)") %>%
  mutate(fastestLap_s = fastestLap_ms/1000) %>%
  group_by(year, raceId) %>%
  mutate(rank = rank(fastestLap_s)) %>%
  filter(rank == 1) %>%
  group_by(full_name, constructor_name) %>%
  summarise(count_of_fastest_lap = n()) %>%
  arrange()

library(ggplot2)
library(plotly)

lap_times_by_driver_2019 %>%
  plot_ly(type = "bar",
          x = ~count_of_fastest_lap, 
          y = ~full_name,
          marker = list(color =c("#DC0000", # Charles LeClerc
                                 "#F0D787", # K Mag (Haas)
                                 "#00D2BE", # Lewis Hamilton; Mercedes
                                 "#1E41FF", # Max Verstappen; Red Bull
                                 "#DC0000", # Vettel Ferrari 2019; Aston Martin 2021
                                 "#00D2BE")),
          text = ~constructor_name,
          hovertemplate = paste('<b>Driver</b>: %{y}<br>',
                                 '<b>Team</b>: %{text}<br>', 
                                 'Number of Fastest Laps</b>: %{x}<br>')) %>%
  layout(title = 'Fastest Laps in 2019', xaxis = list(title = 'Count of Fastest Laps'), 
         yaxis = list(title = 'Driver'))

```


```{r}

lap_times_by_driver_2021 <- 
  lap_times %>%
  left_join(skinny_races_circuits, by = ("raceId")) %>%
  filter(year == 2021) %>%
  left_join(xover, by = c("driverId" = "driverId",
                          "year" = "year")) %>%
  group_by(year, raceId, driverId, full_name, constructor_name) %>%
  summarise(min(milliseconds)) %>%
  rename(fastestLap_ms = "min(milliseconds)") %>%
  mutate(fastestLap_s = fastestLap_ms/1000) %>%
  group_by(year, raceId) %>%
  mutate(rank = rank(fastestLap_s)) %>%
  filter(rank == 1) %>%
  group_by(full_name, constructor_name) %>%
  summarise(count_of_fastest_lap = n()) %>%
  arrange()

lap_times_by_driver_2021 %>%
  plot_ly(type = "bar",
          x = ~count_of_fastest_lap, 
          y = ~full_name,
          marker = list(color =c("#F58020", # Ricciardo Renault 2019, 2021 at McL
                                 "#F58020", # Norris, McLaren
                                 "#00D2BE", # Lewis Hamilton; Mercedes
                                 "#1E41FF", # Max Verstappen; Red Bull
                                 "#4E7C9B", # Gasly Toro Rosso 2019/Alpha Tauri 2021
                                 "#1E5BC6", # Perez, Racing Point 2019, RB 2021
                                 "#00D2BE" # Bottoas, Mercedes
                                 )),
          text = ~constructor_name,
          hovertemplate = paste('<b>Driver</b>: %{y}<br>',
                                 '<b>Team</b>: %{text}<br>', 
                                 'Number of Fastest Laps</b>: %{x}<br>')) %>%
  layout(title = 'Fastest Laps in 2021', xaxis = list(title = 'Count of Fastest Laps'), 
         yaxis = list(title = 'Driver'))
```


Now I'm interested in seeing the average time per lap over the course of a race by circuit.
```{r}
lap_time_by_lap <- lap_times %>%
  drop_na(milliseconds) %>%
  group_by(raceId, lap, time) %>%
  summarise(mean(milliseconds)/1000) %>%
  rename(mean_lap_speed_ms = `mean(milliseconds)/1000`) %>%
  left_join(skinny_races_circuits, by = ("raceId")) %>%
  left_join(circuits_joined, by = ("circuitId")) %>%
  select(raceId, lap, mean_lap_speed_ms, time, circuitId, race_name, year,
          circuit_name) %>%
    filter(year == 2019 | year == 2021) %>%
  mutate_at(c("year"), as.factor)

library(RColorBrewer)

lap_time_by_lap %>%
  ggplot(aes(x = lap, y = mean_lap_speed_ms, color = year)) + 
  geom_point() + ylim(0,300) + 
  scale_fill_brewer(palette = "Spectral") +
  facet_wrap(vars(circuit_name))
```

This looks cool, but I think it would be better as an interactive/drop down so you can really zoom in.
```{r}
# library(plotly)
# 
# lap_time_by_lap %>%
#     plot_ly(x = ~lap, y = ~mean_lap_speed_ms, color = ~year,
#             hoverinfo = "text", hovertext = ~time) +  facet_wrap(~circuit_name)
# 
# lap_time_by_lap %>%
#   filter(year > 2010)
#     group_by(circuit_name) %>%
#     do(p=plot_ly(., x = ~lap, y = ~mean_lap_speed_ms, color = ~year, type = "scatter")) %>%
#   subplot(nrows = 5, shareX = TRUE, shareY = TRUE)
```


```{r}
library(lubridate)
incidents_by_circuit <- 
  results %>%
  left_join(status2, by = ("statusId")) %>%
  left_join(races, by = ("raceId")) %>%
  rename(race_name = name) %>%
  filter(year == 2019 | year == 2021) %>%
  select(date, raceId, race_name, driverId, constructorId, statusId, status) %>%
  left_join(xover, by = ("constructorId")) %>%
  group_by(year, date, raceId, race_name, constructor_name, status) %>%
  filter(status == "Collision" | status == "Accident") %>%
  select(year, date, race_name, full_name, constructor_name, status)

incidents_by_circuit$date <- lubridate::ymd(incidents_by_circuit$date)
```

2019 breakdown of incidents by constructor
```{r}
incidents_by_circuit %>%
  filter(year == 2019) %>%
  group_by(constructor_name) %>%
  summarise(n = n()) %>%
  plot_ly(type = "bar",
          x = ~constructor_name, 
          y = ~n,
          marker = list(color =  c("#9B0000", # Alfa Romeo
                                  "#DC0000", # Ferrari
                                  "#F0D787", # Haas
                                  "#FF8700", # McLaren
                                  "#00D2BE", # Mercedes
                                  "#F596C8", # Racing Point
                                  "#1E41FF", # Red Bull
                                  "#FFF500", # Renault
                                  "#469BFF", # Toro Rosso
                                  "#FFFFFF" # Williams
                                  )),
          # text = ~constructor_name,
          hovertemplate = paste('<b>Team</b>: %{x}<br>', 
                                 'Number of Accidents or Collisions</b>: %{y}<br>')) %>%
  layout(title = 'Incidents by Constructor in 2019',
         xaxis = list(title = 'Constructor'), 
         yaxis = list(title = 'Count of Accidents or Collisions'))
```

2021 breakdown of incidents by constructor
```{r}
incidents_by_circuit %>%
  filter(year == 2021) %>%
  group_by(constructor_name) %>%
  summarise(n = n()) %>%
  plot_ly(type = "bar",
          x = ~constructor_name, 
          y = ~n,
          marker = list(color =  c("#B12039", # Alfa Romeo
                                   "#4E7C9B", # Alpha Tauri
                                   "#2293D1", # Alpine
                                   "#2D826D", # Aston Martin
                                   "#ED1C24", # Ferrari
                                   "#B6BABD", # Haas
                                   "#F58020", # McLaren
                                   "#6CD3BF", # Mercedes
                                   "#1E5BC6", # Red Bull
                                   "#37BEDD" # Williams
                                  )),
          # text = ~constructor_name,
          hovertemplate = paste('<b>Team</b>: %{x}<br>', 
                                 'Number of Accidents or Collisions</b>: %{y}<br>')) %>%
  layout(title = 'Incidents by Constructor in 2021',
         xaxis = list(title = 'Constructor'), 
         yaxis = list(title = 'Count of Accidents or Collisions'))

```
